<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Successful</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <div class="container">
        <div class="success-message">
            <h1>Payment Successful!</h1>
            <p>Thank you for your purchase. You now have access to your products.</p>
        </div>
        
        <div class="order-details">
            <h3>Your Order:</h3>
            <div id="purchased-items">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
        
        <div class="action-buttons">
            <button class="primary-btn" onclick="window.location.href='final-success.html'">
                Continue
            </button>
        </div>
    </div>

    <!-- Popup Modal -->
    <div id="upsell-popup" class="popup-overlay" style="display: none;">
        <div class="popup-content">
            <div class="popup-header">
                <h2>Special Offer!</h2>
                <span class="close-popup" onclick="closePopup()">&times;</span>
            </div>
            
            <div class="popup-body">
                <div class="popup-image">
                    <span>ðŸ’Ž</span>
                </div>
                <h3 id="popup-product-name">Loading...</h3>
                <p id="popup-product-description">Special final offer just for you!</p>
                
                <div class="popup-pricing">
                    <div class="price">
                        <span class="current-price" id="popup-product-price">Â£0.00</span>
                    </div>
                    <p class="savings">Limited Time Offer!</p>
                </div>
            </div>
            
            <div class="popup-actions">
                <button id="popup-buy-btn" class="upsell-btn primary">
                    <span class="btn-text">Yes, I Want This!</span>
                    <span class="loader" style="display: none;">Processing...</span>
                </button>
                <button class="upsell-btn secondary" onclick="closePopup()">
                    No Thanks
                </button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Configuration
        const API_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000' 
            : ''; // Empty string for relative URLs in production
            
        // ===== SUCCESS PAGE UPSELL CONFIGURATION =====
        // Toggle between free product and Stripe product
        const USE_FREE_PRODUCT = false; // Set to true for free product, false for Stripe product
        
        // Free Product Configuration (when USE_FREE_PRODUCT = true)
        const FREE_PRODUCT_CONFIG = {
            product: {
                id: 'free_discovery_call',
                name: 'Free Discovery Call',
                description: 'Get a free 30-minute strategy session with our experts'
            },
            price: {
                amount: 0,
                formatted: 'FREE',
                currency: 'gbp'
            }
        };
        
        // Stripe Product Configuration (when USE_FREE_PRODUCT = false)
        const STRIPE_PRODUCT_ID = 'prod_SYtBaNxeD562ly';
        
        // Get the final product ID to use
        const FINAL_UPSELL_PRODUCT_ID = USE_FREE_PRODUCT ? FREE_PRODUCT_CONFIG.product.id : STRIPE_PRODUCT_ID;
        
        // Stripe configuration
        const STRIPE_PUBLISHABLE_KEY = 'pk_test_51RdlIsPMvURrXJGvNX7UdYKOxdVRZhOL4tF30FEBtgwrSKjZOeTpGsEanJhTrWu6xbB2KwpUnQVlsecw3iehapiM00iLLooZV3';
        
        let stripe = null;
        let finalUpsellProduct = null;
        let customerPaymentMethod = null;
        let customerId = null;
        
        function formatPrice(amountInCents) {
            return `Â£${(amountInCents / 100).toFixed(2)}`;
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize Stripe with publishable key
            stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
            
            await loadPaymentDetails();
            await loadFinalUpsellProduct();
            showOrderDetails();
            
            // Show popup after a delay
            setTimeout(showUpsellPopup, 2000);
        });
        
        async function loadPaymentDetails() {
            try {
                const paymentData = localStorage.getItem('paymentSuccess');
                if (!paymentData) {
                    window.location.href = 'index.html';
                    return;
                }
                
                const { paymentIntentId } = JSON.parse(paymentData);
                
                const response = await fetch(`${API_URL}/api/confirm-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ paymentIntentId })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    console.error('Error loading payment details:', data.error);
                    return;
                }
                
                customerPaymentMethod = data.paymentIntent.payment_method_id;
                customerId = data.paymentIntent.customer_id;
                
                console.log('Payment details loaded:', {
                    paymentMethod: customerPaymentMethod,
                    paymentMethodType: typeof customerPaymentMethod,
                    customer: customerId
                });
                
            } catch (error) {
                console.error('Error loading payment details:', error);
            }
        }
        
        async function loadFinalUpsellProduct() {
            try {
                if (USE_FREE_PRODUCT) {
                    // Use the free product configuration
                    finalUpsellProduct = FREE_PRODUCT_CONFIG;
                    
                    // Update popup content
                    document.getElementById('popup-product-name').textContent = FREE_PRODUCT_CONFIG.product.name;
                    document.getElementById('popup-product-description').textContent = FREE_PRODUCT_CONFIG.product.description;
                    document.getElementById('popup-product-price').textContent = FREE_PRODUCT_CONFIG.price.formatted;
                } else {
                    // Load from Stripe
                    const response = await fetch(`${API_URL}/api/get-product?product_id=${STRIPE_PRODUCT_ID}`);
                    const data = await response.json();
                    
                    if (!data.error) {
                        finalUpsellProduct = data;
                        
                        // Update popup content
                        document.getElementById('popup-product-name').textContent = data.product.name;
                        document.getElementById('popup-product-description').textContent = data.product.description || 'Special final offer just for you!';
                        document.getElementById('popup-product-price').textContent = data.price.formatted;
                    }
                }
            } catch (error) {
                console.error('Error loading final upsell product:', error);
            }
        }
        
        function showOrderDetails() {
            const paymentData = localStorage.getItem('paymentSuccess');
            const mainProduct = localStorage.getItem('mainProduct');
            
            if (!paymentData || !mainProduct) return;
            
            const { includedUpsell } = JSON.parse(paymentData);
            const mainProductData = JSON.parse(mainProduct);
            
            let html = `
                <div class="order-item">
                    <span>${mainProductData.product.name}</span>
                    <span>${mainProductData.price.formatted}</span>
                </div>
            `;
            
            if (includedUpsell) {
                html += `
                    <div class="order-item">
                        <span>Advanced Bundle</span>
                        <span>Included</span>
                    </div>
                `;
            }
            
            document.getElementById('purchased-items').innerHTML = html;
        }
        
        function showUpsellPopup() {
            if (!finalUpsellProduct) return;
            
            document.getElementById('upsell-popup').style.display = 'flex';
            
            // Setup buy button (only add listener once)
            const buyButton = document.getElementById('popup-buy-btn');
            if (!buyButton.hasAttribute('data-listener-added')) {
                buyButton.addEventListener('click', handlePopupPurchase);
                buyButton.setAttribute('data-listener-added', 'true');
            }
        }
        
        function closePopup() {
            document.getElementById('upsell-popup').style.display = 'none';
        }
        
        async function handlePopupPurchase() {
            if (!finalUpsellProduct) {
                alert('Product not loaded. Please try again.');
                return;
            }
            
            const buyButton = document.getElementById('popup-buy-btn');
            setButtonLoading(buyButton, true);
            
            try {
                console.log('Starting popup purchase for:', finalUpsellProduct.product.name);
                console.log('Product amount:', finalUpsellProduct.price.amount);
                
                // Get customer info for webhook
                const customerInfo = localStorage.getItem('customerInfo');
                const customerData = customerInfo ? JSON.parse(customerInfo) : null;
                
                // Validate we have customer ID and payment method for paid products
                if (finalUpsellProduct.price.amount > 0) {
                    if (!customerId) {
                        throw new Error('Customer ID not found. Please try again.');
                    }
                    if (!customerPaymentMethod) {
                        throw new Error('Payment method not found. Please try again.');
                    }
                    console.log('Using customer:', customerId, 'with payment method:', customerPaymentMethod);
                }
                
                // Handle free products (amount = 0)
                if (finalUpsellProduct.price.amount === 0) {
                    console.log('Free product detected, skipping payment processing');
                    
                    // Send webhook for free product acceptance
                    if (customerData) {
                        const upsellData = {
                            paymentIntentId: 'free_product',
                            product: {
                                id: finalUpsellProduct.product.id,
                                name: finalUpsellProduct.product.name,
                                price: finalUpsellProduct.price.amount,
                                priceFormatted: finalUpsellProduct.price.formatted
                            },
                            totalOrderValue: 0,
                            totalOrderValueFormatted: 'FREE'
                        };
                        await sendSuccessWebhook(customerData, upsellData);
                    }
                    
                    // Store final purchase data
                    localStorage.setItem('finalUpsellPurchase', JSON.stringify({
                        paymentIntentId: 'free_product',
                        productId: finalUpsellProduct.product.id,
                        amount: finalUpsellProduct.price.amount,
                        type: 'free'
                    }));
                    
                    // Redirect to final success page
                    window.location.href = 'final-success.html';
                    
                    return;
                }
                
                // Create payment intent for paid products
                const response = await fetch(`${API_URL}/api/create-payment-intent`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: finalUpsellProduct.price.amount,
                        currency: 'gbp',
                        customer: customerId,
                        metadata: {
                            final_upsell: finalUpsellProduct.product.id,
                            product_name: finalUpsellProduct.product.name
                        }
                    })
                });
                
                const responseData = await response.json();
                
                if (!response.ok || responseData.error) {
                    throw new Error(responseData.error || 'Failed to create payment intent');
                }
                
                const { clientSecret } = responseData;
                
                if (!clientSecret) {
                    throw new Error('No client secret received');
                }
                
                console.log('Payment intent created, confirming payment...');
                
                // Confirm payment with saved payment method
                let result;
                if (customerPaymentMethod) {
                    // Use saved payment method - ensure we're using just the ID string
                    const paymentMethodId = typeof customerPaymentMethod === 'string' 
                        ? customerPaymentMethod 
                        : customerPaymentMethod.id;
                        
                    console.log('Using saved payment method ID:', paymentMethodId);
                    
                    result = await stripe.confirmCardPayment(clientSecret, {
                        payment_method: paymentMethodId
                    });
                } else {
                    // This shouldn't happen, but fallback to prompting for new card
                    console.log('No saved payment method found, using default confirmation');
                    result = await stripe.confirmCardPayment(clientSecret);
                }
                
                if (result.error) {
                    console.error('Payment confirmation error:', result.error);
                    alert('Payment failed: ' + result.error.message);
                } else {
                    // Success - calculate total order value and send webhook
                    if (customerData) {
                        // Calculate total order value (previous purchase + this upsell)
                        const paymentSuccess = localStorage.getItem('paymentSuccess');
                        let previousOrderAmount = 0;
                        
                        if (paymentSuccess) {
                            const paymentData = JSON.parse(paymentSuccess);
                            const mainProduct = localStorage.getItem('mainProduct');
                            if (mainProduct) {
                                const main = JSON.parse(mainProduct);
                                previousOrderAmount += main.price.amount;
                                
                                if (paymentData.includedUpsell) {
                                    // Add estimated upsell amount if included
                                    previousOrderAmount += 2000; // This should be the actual amount from checkout
                                }
                            }
                        }
                        
                        const totalOrderValue = previousOrderAmount + finalUpsellProduct.price.amount;
                        
                        // Prepare upsell data for webhook
                        const upsellData = {
                            paymentIntentId: result.paymentIntent.id,
                            product: {
                                id: finalUpsellProduct.product.id,
                                name: finalUpsellProduct.product.name,
                                price: finalUpsellProduct.price.amount,
                                priceFormatted: finalUpsellProduct.price.formatted
                            },
                            totalOrderValue: totalOrderValue,
                            totalOrderValueFormatted: formatPrice(totalOrderValue)
                        };
                        
                        // Send success webhook
                        await sendSuccessWebhook(customerData, upsellData);
                    }
                    
                    // Store the paid product purchase
                    const finalUpsellData = {
                        product: finalUpsellProduct.product,
                        price: finalUpsellProduct.price,
                        type: 'paid',
                        paymentIntent: result.paymentIntent.id
                    };
                    localStorage.setItem('finalUpsellPurchase', JSON.stringify(finalUpsellData));
                    
                    console.log('Payment successful:', result.paymentIntent);
                    
                    // Redirect to final success page
                    window.location.href = 'final-success.html';
                }
                
            } catch (error) {
                console.error('Popup purchase error:', error);
                alert('Payment failed: ' + error.message);
            } finally {
                setButtonLoading(buyButton, false);
            }
        }
        
        // Close popup when clicking outside
        document.getElementById('upsell-popup').addEventListener('click', function(e) {
            if (e.target === this) {
                closePopup();
            }
        });
        
        async function sendSuccessWebhook(customerData, upsellData) {
            try {
                const webhookData = {
                    event: 'success_upsell_accepted',
                    timestamp: new Date().toISOString(),
                    customer: {
                        firstName: customerData.firstName,
                        lastName: customerData.lastName,
                        fullName: `${customerData.firstName} ${customerData.lastName}`,
                        email: customerData.email,
                        phone: customerData.phone
                    },
                    upsell: {
                        paymentIntentId: upsellData.paymentIntentId,
                        product: {
                            id: upsellData.product.id,
                            name: upsellData.product.name,
                            price: upsellData.product.price,
                            priceFormatted: upsellData.product.priceFormatted
                        },
                        totalOrderValue: upsellData.totalOrderValue,
                        totalOrderValueFormatted: upsellData.totalOrderValueFormatted,
                        currency: 'GBP'
                    }
                };
                
                console.log('Sending success webhook:', webhookData);
                
                const response = await fetch('https://hooks.zapier.com/hooks/catch/2299769/ub2fcwq/', {
                    method: 'POST',
                    body: JSON.stringify(webhookData)
                });
                
                if (response.ok) {
                    console.log('Success webhook sent successfully');
                } else {
                    console.warn('Success webhook failed:', response.status);
                }
            } catch (error) {
                console.error('Error sending success webhook:', error);
                // Don't block the user flow if webhook fails
            }
        }


    </script>
</body>
</html> 